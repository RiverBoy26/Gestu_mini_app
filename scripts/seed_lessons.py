import os
from dotenv import load_dotenv

load_dotenv()

from app.backend.db import engine, Base, get_session
from app.backend.db.models import Category, Lesson


def norm_desc(s: str) -> str:
    s = (s or "").strip()
    if not s:
        return s
    if not s[0].isupper():
        s = s[0].upper() + s[1:]
    if not s.endswith("."):
        s += "."
    return s


CATEGORIES = [
    {"slug": "words", "title": "Алфавит", "order": 1},
    {"slug": "animals", "title": "Животные", "order": 2},
    {"slug": "numbers", "title": "Числа", "order": 3},
]

NUMBERS_DESC = {
    "0": 'Круговыми движениями показать знак “Окей”.',
    "1": "Показать указательный палец вверх.",
    "2": "Показать указательный и средний палец вместе.",
    "3": "Показать указательный, средний и безымянный пальцы вместе.",
    "4": "Показать все пальцы кроме большого вместе.",
    "5": "Показать все пальцы ладони.",
    "6": "Показать внутреннюю часть ладони и приложить к ней большой палец другой руки.",
    "7": "Приложить к внутренней стороне ладони два пальца.",
    "8": "Приложить к внутренней стороне ладони первые три пальца другой руки.",
    "9": "Приложить к внутренней стороне ладони четыре пальцы другой руки.",
}

ANIMALS = [
    ("cat", "Кошка", "Приложить указательный палец к большому, растопырить остальные пальцы и круговыми движениями повращать руку."),
    ("dog", "Собака", "Сформировать большим пальцем и остальными подобие глаза, несколько раз сомкнуть и разомкнуть их."),
    ("dolphin", "Дельфин", "Сформировать пальцами руки “пистолет” и волнообразными движениями двигать рукой горизонтально."),
    ("donkey", "Осёл", "Загнуть большие пальцы внутрь ладони, приложить внутренней стороной руки к голове и помахать кистями параллельно друг другу."),
    ("eagle", "Орел", "Сложить руку в кулак, вытащить и согнуть указательный палец, приложить ко рту и повращать руку вниз, затем раскрыть ладони и “помахать” как крыльями."),
    ("elephant", "Слон", "Из пальцев рук сформировать туннель, приложить к носу и s-образной опустить руку вниз."),
    ("fox", "Лиса", "Совершить движение, как будто ладонью хочешь ухватиться за свой нос и вытянуть его."),
    ("goat", "Коза", "Сжать руку в кулак, вытащить указательный и средний палец вместе, приложить кисть к подбородку, пошевелить пальцами."),
    ("moose", "Лось", "Широко раскрыть пальцы рук, большими пальцами приложить к голове."),
    ("snake", "Змея", "Указательный палец приложить ко рту, описать две окружности, опуская руку."),
]

ALPHABET = [
    ("А", "Кулак вверх"),
    ("Б", "Согнуть средний палец, приложить к прямому указательному, согнуть дугой безымянный и мезинец, приложить к ним кончик большой пальца, поднять кисть вверх"),
    ("В", "Сложить руку в 90 градусов, прижать все пальцы к ладони"),
    ("Г", "Сформировать угол большим пальцем и указательным, указать рукой вниз"),
    ("Д", "Вытянуть указательный и средний вместе, описать окружность кистью"),
    ("Е", "Сформировать туннель ладонью, поднять руку вверх"),
    ("Ё", "Сформировать туннель ладонью, покрутить кисть"),
    ("Ж", "Сложить пальцы рук в подобие буквы Г, приложить руку к себе"),
    ("З", "Показать указательным пальцем силуэт буквы"),
    ("И", "Сложить руку в кулак, оттопырить безымянный и мизинец"),
    ("Й", "Сложить руку в кулак, оттопырить безымянный и мизинец, показать поочередно тыльную и внутреннюю часть сложенной руки"),
    ("К", "Сложить указательный и средний пальцы вместе, махнуть кистью вверх-вниз"),
    ("Л", "Сформировать силуэт буквы двумя пальцами, направить кисть вниз"),
    ("М", "Указательный, средний и безымянный пальцы руки наклонить вниз"),
    ("Н", "Раскрыть пальцы рук, сомкнуть кончики большого и безымянного пальцев"),
    ("О", "Сомкнуть указательный и большой пальцы руки"),
    ("П", "Сложить указательный и средний вместе, указать ими вниз"),
    ("Р", "Сомкнуть средний и большой палец, остальные выпрямить и мизинец отогнуть назад"),
    ("С", "Сформировать силуэт буквы всеми пальцами руки"),
    ("Т", "Сложить большой палец и мизинец вместе, остальные выпрямить, кисть наклонить вниз"),
    ("У", "Сложить руку в кулак, оттопырить мизинец и большой"),
    ("Ф", "Сформировать угол всеми пальцами руки кроме большого, его оттопырить"),
    ("Х", "Сложить пальцы в кулак, загнуть указательный углом"),
    ("Ц", "Сложить указательный и средний вместе, поводить рукой вверх-вниз"),
    ("Ш", "Выпрямить пальцы рук, смокнуть мизинец и большой палец вместе"),
    ("Щ", "Выпрямить пальцы рук, смокнуть мизинец и большой палец вместе, поводить руку вверх-вниз"),
    ("Ъ", "Сложить указательный и большой пальцы углом, поочередно показать тыльную и внутреннюю часть ладони"),
    ("Ы", "Сложить руки в кулак, выпрямить мизинец и указательный, указать рукой наискосок вверх"),
    ("Ь", "Сложить указательный и большой углом, поочередного приложить к себе внутреннюю и тыльную сторону руки"),
    ("Э", "Указательный и большим пальцем сформировать силуэт буквы"),
    ("Ю", "Сформировать глаз пальцами руки, оттопырить мизинец"),
    ("Я", "Указать указательным пальцем на себя"),
]


def upsert_category(db, slug: str, title: str, order: int) -> Category:
    c = db.query(Category).filter_by(slug=slug).first()
    if not c:
        c = Category(slug=slug, title=title, category_order=order)
        db.add(c)
        db.commit()
        db.refresh(c)
        return c
    changed = False
    if c.title != title:
        c.title = title
        changed = True
    if getattr(c, "category_order", None) != order:
        c.category_order = order
        changed = True
    if changed:
        db.commit()
        db.refresh(c)
    return c


def upsert_lesson(db, category_id: int, order: int, title: str, description: str, content_url: str):
    l = db.query(Lesson).filter_by(category_id=category_id, lesson_order=order).first()
    if not l:
        l = Lesson(
            category_id=category_id,
            lesson_order=order,
            title=title,
            description=norm_desc(description),
            content_url=content_url,
        )
        db.add(l)
        return

    l.title = title
    l.description = norm_desc(description)
    l.content_url = content_url


def main():
    Base.metadata.create_all(engine)

    db = get_session()
    try:
        cats = {}
        for c in CATEGORIES:
            cats[c["slug"]] = upsert_category(db, c["slug"], c["title"], c["order"])

        ncat = cats["numbers"]
        for d in range(0, 10):
            k = str(d)
            upsert_lesson(
                db,
                category_id=ncat.category_id,
                order=d + 1,
                title=k,
                description=NUMBERS_DESC[k],
                content_url=f"/videos/numbers/{k}.mp4",
            )

        acat = cats["animals"]
        for i, (fname, ru_title, desc) in enumerate(ANIMALS, start=1):
            upsert_lesson(
                db,
                category_id=acat.category_id,
                order=i,
                title=ru_title,
                description=desc,
                content_url=f"/videos/animals/{fname}.mp4",
            )

        wcat = cats["words"]
        for i, (letter, desc) in enumerate(ALPHABET, start=1):
            upsert_lesson(
                db,
                category_id=wcat.category_id,
                order=i,
                title=letter,
                description=desc,
                content_url=f"/videos/words/{letter}.mp4",
            )

        db.commit()
        print("OK: categories+lessons seeded")
    finally:
        db.close()


if __name__ == "__main__":
    main()
